use crate::codec::{byte_decode, byte_decode_12};
use crate::ntt::NTT;
use crate::params::{DU, DV, N, RANK};
use crate::ring::Poly;

#[allow(unused)]
pub struct DecryptionKey {
    key: [u8; 384 * RANK],
}

#[allow(unused)]
impl DecryptionKey {
    pub fn new(key: [u8; 384 * RANK]) -> Self {
        DecryptionKey { key }
    }

    pub(crate) fn key_bytes(&self) -> (&[u8]) {
        &self.key
    }

    pub fn decrypt(&self, c: [u8; 32 * (DU as usize * RANK + DV as usize)]) -> [u8; 32] {
        let c1: [u8; 32 * DU as usize * RANK] = c[0..32 * DU as usize * RANK]
            .try_into()
            .expect("ciphertext 1");
        let c2: [u8; 32 * DV as usize] = c[32 * DU as usize * RANK..]
            .try_into()
            .expect("ciphertext 2");

        let mut f: [[u16; N]; RANK] = [[0u16; N]; RANK];
        for i in 0..RANK {
            byte_decode(
                &c1[i * 32 * DU as usize..][..32 * DU as usize],
                &mut f[i],
                DU,
            );
        }
        let udh: [NTT; RANK] = {
            let u_dash: [Poly; RANK] = f.map(|f_| Poly::from(&f_).decompress::<DU>());
            u_dash.map(|ud| NTT::from_poly(&ud))
        };

        let sh: [NTT; RANK] = {
            let mut s = [[0u16; N]; RANK];
            let b = self.key_bytes();
            for i in 0..RANK {
                byte_decode_12(&b[i * 384..][..384], &mut s[i]);
            }
            s.map(|s| NTT::from(s))
        };

        let v_dash: Poly = {
            let mut vf: [u16; N] = [0u16; N];
            byte_decode(&c2, &mut vf, DV);
            Poly::from(&vf).decompress::<DV>()
        };

        let mut r: NTT = NTT::default();
        for i in 0..RANK {
            r = r.add(&sh[i].mul(&udh[i]));
        }
        let w = v_dash.sub(&r.inv());

        let m: [u8; 32] = w.compress_1().byte_encode_1();
        m
    }
}

#[cfg(test)]
mod mlkem768_cpa_decrypt_tests {
    use crate::params::{DU, DV, RANK};
    use crate::{pke, prf};

    #[test]
    fn test_decrypt_00() {
        let d = hex::decode("684a29e4e5480a5f2533e1526b5fac8cdf5927f3d85087c71f928c59690eb565")
            .unwrap();
        let d: [u8; 32] = d.try_into().unwrap();
        let exp_pk: [u8; 1184] = hex::decode("4f27944614c35d121bf2390402bc93797055936a2d49699cdeec2f29413403aa1024d802d97c54aa316707c26a0b432821f63cd89a87f769597cec8356c2c399d3a34115cca89b9df6a55e4556a3b2150b51907ce67b860f697a65b199b370691fdcb31cf7937d1524bef41a0732cfdf464175c95d9092176ce52814d3a9231114cc31718755ccd3a7b3fe69b4290175dc440cd38c69faecb190ca684fb1001b5308fb4c1ff6a55b4be8814d602ec59c2deed654c93a45d55a3e020800e98aa786c76fcf33cea3a7bdbffa5037a171044b1b74d6094d1a3b606009b4fb0f060b6dd1d29ae67ab90c90c25db895c9515fe0a17bdd69c6773518a532ae8ac731e32155500204dae2c9284cc16f61b5a9e48334859357506e2c391d1bd38865ea489e492d8b847a6a50ba074320fa32074d89894324a705dba4e1847a5059645c77063809cbf3cb0555b6be4069c77b10a6c6f67ae1e7c09d603e87a34acd3b814d7b4798dc05acba65220289772abdbd89403e698f3556511e152bc0f77509dc36803b57d08129951ac44ecc49f43b7cfe8436baa8b5376999f6442293352e76ac592b95804217817ad5a75a76caa72172df9c69da4c170e937a69d93f12c7b533d4bce41b34d0cc8a1c969947db2c21a960d975ac029280ecbb527654a42385576286915d4b8f3fd163f0cb280736bee89786fa277c8487b0820416985855a95a10647059cf34c08915985c32321b5b8b45a468cd4253c662847eea36fb238098f059630cac83aa70cc9596cc1a0406e993b737c236e78cfbea1191d60fc6428fe7090997f1ab41c13e0c57a256a813bc559ad1e6ad10dc3cf43a64dae2955f03b46a09ac6ee30326d95d6ca8b80e61aab77579c017a1906279ac09766bd8a1b40b24d8bc4deefaab47f9c14a8441eb413dbd718e5122ae7beb94f526a31bda25d893a544670d994530d3c6ca29879085870f6d54192b1a7fd63193c7423be4867d2c134683ba25f9240e0fa2a96b47c5ac05b541c2980f51557989b3eba42dad002412f462acf75b141c5fc320bdafd3c11be291eafc04d6b5a1d4117c7703c313eaa30477253e938764364b25d859aca263962c5d6d898ada856b70e151dfa41289213acda6cdb5241bc7067bee5cb467c34d2b0a6ded6aa746290ee2e40b7be1294c583aaf415dd03213a3cb2e41f10731823e749acbc53767c12b93d8f32257a54c6a71b2041a167d685f0bf789b94b277f1b60af22c09b639ac72ca25b1c69b855bed6377126999c5708789091cedce768b253ccae981715c8922dc9562ea8a0ba102b02585281b15c7e44339cf630529c1b076106ee2b5c7be0181ce43d397a398c8547da703e2ab47bc15284f4c6a50dcb904ec9c1f60a1aeef38435997871e8501d4832bbb2a3354c70d9579f237427135329cda32573089687d9a9130375bf66ac321113a25a08aa75cb667635455a93eae7a0a6703a2dc0a85637681ecb097f1b16b2b331210b6288b13f5752bb6c731adab30ca051a817099095022892d923f571b8d879c8ddf0ab03145a32298dc6b644b25640d808006e3113accc6a0c1ccb05ec273e6b6559e287539c72d754ba9bc48c915acebb656e3cb7713e9bfc0bb6f311485ebaa078b78a737d81d38d368c220eb0e982fb0bd8a7ed97").unwrap().try_into().unwrap();
        let exp_sk: [u8; 2400] = hex::decode("c2bcc42efa0baf63bae062a1b1322114519cc504048ff26ee73b208d659518a286dc411c3097293d79bfe04790f8b87c1dca42059c447ca5a382733c27550b41a367e19175e084c49b9bc5b8d1ace0eb4ef2b220f187929171a10d5a9a46c8b89ccba3b2435720780f6851b01cb06ef5127100c4ca44c6188aa3af8e875b85317f47797d6d699e6d619441b26fee871863392ff455413ea78d53852d5b19361ce82432410adc6ba90793cd3330444b82a06da38a131a1ca91756848ca59e200c86001c21d19a7b5a40692a979bd351ff140276f176c9f189e3499d067cb054f9a5725236abba148cf05a539675331352834ca583b8029c764ebe829cbeb934ba76bf3e75a1a2b0a65b879cb0b881dda38487558adec31029783ba7ccc94ac879690049452724c3073106790748d57102236f4e9cc4159a14a042cc4c6986ed5c4027b28053d673f42811b4e54fd62507115b990849a9c3ea6153b405b6c73f27f6755db5c489761da376ca05031e027b6a34b12117ab8cdd1965cb958e6e0a7a8f9b8a780b0d06625ae7b8b5d2e97510c3c8a3b010b46506db23ad99f509d3342df563c2ccd951a7f0446d582ccc872aac034a27a90822506af8acc35f321bced03f1dbba19507c17688965b59176563088cd44dfcbca8a60baff382b15f812768c41d3aa6227c760e78fbc5e8191b01e697104164d8c1bdd2133aa222886263a573cb3d18743ebaf7abc486c5ad24cdd770250ff860acf05a88cb464088cf23c82f9a191833a780ef44bbf5a06cf1442fcffa547ffb354c8476c0b8135c6abff733c30f38a3ff331a836492ba26c668b679da54463b68573d566de97a2b4a53cf9621a6a5a7493ff190b5c9a7ea63019fd1c3a4dbc395d0b254c80f7b5668e6074fb0bccbab9811010b1c42d55982928d604ac9f3b5c0a3888cbce54cf0e1ae0c9914fb5474ec29492cd1bef2537c4e3837ffabb058993c3fd11253e87e15e84451269b6a48911ef15e4f82606a475cacf420ed6796ac04af07633b6ea63af927c611b07dd932bd0ce852c4b785f7348fe2906eafc76c3df8706735813ff796ae51837c198e2eeccbd0a64b45254209882351740fb6414363976ddbe5c302a29dcd832270732e2c6abea1969e8b17ce2b1807aaf2485e6b07e3a7419b5019b8172a3ea0b7907a70589a88cde16d1b043d7985860f623b95645ca1921ac8109870758016a5bdf37acaa273c18b6944d0911a0d255b4f9580e3b50383f93bb7871f3fc2b280f2871b1c17b2c74b9368773ab747ec2b87209910cfa859243b7a75288c163ba025fb667025433b12c471e7c9642c4ab105413e0641d7e961b3fa462ec797d6a9cec7ab1ef6a64b5d5869c4e6c3ec884afb87b2a8711a46014dad830fcc195dcc5b966252c5a350561b0359efd07df9a4b4bfc39ae6441cd70b57a4718d55a0bfd8f979c0d01e31787afbb1a8c2a87e5a7b70d8976ae4814950d00e998927039111eda21993c17fb107034faa658617568350a48dc4bb3b124b032b35ede2ba312162b57067ab245533177dae67894349327663c329c2a752002326b18cc60b1cd1098968d18168bbbcab459f4a4c18f63a7dd0e9ca68f43a6592484f27944614c35d121bf2390402bc93797055936a2d49699cdeec2f29413403aa1024d802d97c54aa316707c26a0b432821f63cd89a87f769597cec8356c2c399d3a34115cca89b9df6a55e4556a3b2150b51907ce67b860f697a65b199b370691fdcb31cf7937d1524bef41a0732cfdf464175c95d9092176ce52814d3a9231114cc31718755ccd3a7b3fe69b4290175dc440cd38c69faecb190ca684fb1001b5308fb4c1ff6a55b4be8814d602ec59c2deed654c93a45d55a3e020800e98aa786c76fcf33cea3a7bdbffa5037a171044b1b74d6094d1a3b606009b4fb0f060b6dd1d29ae67ab90c90c25db895c9515fe0a17bdd69c6773518a532ae8ac731e32155500204dae2c9284cc16f61b5a9e48334859357506e2c391d1bd38865ea489e492d8b847a6a50ba074320fa32074d89894324a705dba4e1847a5059645c77063809cbf3cb0555b6be4069c77b10a6c6f67ae1e7c09d603e87a34acd3b814d7b4798dc05acba65220289772abdbd89403e698f3556511e152bc0f77509dc36803b57d08129951ac44ecc49f43b7cfe8436baa8b5376999f6442293352e76ac592b95804217817ad5a75a76caa72172df9c69da4c170e937a69d93f12c7b533d4bce41b34d0cc8a1c969947db2c21a960d975ac029280ecbb527654a42385576286915d4b8f3fd163f0cb280736bee89786fa277c8487b0820416985855a95a10647059cf34c08915985c32321b5b8b45a468cd4253c662847eea36fb238098f059630cac83aa70cc9596cc1a0406e993b737c236e78cfbea1191d60fc6428fe7090997f1ab41c13e0c57a256a813bc559ad1e6ad10dc3cf43a64dae2955f03b46a09ac6ee30326d95d6ca8b80e61aab77579c017a1906279ac09766bd8a1b40b24d8bc4deefaab47f9c14a8441eb413dbd718e5122ae7beb94f526a31bda25d893a544670d994530d3c6ca29879085870f6d54192b1a7fd63193c7423be4867d2c134683ba25f9240e0fa2a96b47c5ac05b541c2980f51557989b3eba42dad002412f462acf75b141c5fc320bdafd3c11be291eafc04d6b5a1d4117c7703c313eaa30477253e938764364b25d859aca263962c5d6d898ada856b70e151dfa41289213acda6cdb5241bc7067bee5cb467c34d2b0a6ded6aa746290ee2e40b7be1294c583aaf415dd03213a3cb2e41f10731823e749acbc53767c12b93d8f32257a54c6a71b2041a167d685f0bf789b94b277f1b60af22c09b639ac72ca25b1c69b855bed6377126999c5708789091cedce768b253ccae981715c8922dc9562ea8a0ba102b02585281b15c7e44339cf630529c1b076106ee2b5c7be0181ce43d397a398c8547da703e2ab47bc15284f4c6a50dcb904ec9c1f60a1aeef38435997871e8501d4832bbb2a3354c70d9579f237427135329cda32573089687d9a9130375bf66ac321113a25a08aa75cb667635455a93eae7a0a6703a2dc0a85637681ecb097f1b16b2b331210b6288b13f5752bb6c731adab30ca051a817099095022892d923f571b8d879c8ddf0ab03145a32298dc6b644b25640d808006e3113accc6a0c1ccb05ec273e6b6559e287539c72d754ba9bc48c915acebb656e3cb7713e9bfc0bb6f311485ebaa078b78a737d81d38d368c220eb0e982fb0bd8a7ed97ed3d1dd05854a6542b24090a680b9aa9d6c65ef31cf1f4f5708affafeb2e3989bb3eeac4320f84d09cad413a7d7c19c27668b2e0e1bbba2d159b833db6c0f50a").unwrap().try_into().unwrap();
        let (pk, dk, _) = pke::key_gen(d);
        assert_eq!(pk.key_bytes(), exp_pk);
        assert_eq!(dk.key_bytes(), &exp_sk[0..384 * RANK]);

        let m: [u8; 32] =
            hex::decode("492d4cea1c6e07d9535ab2fc21d773bea7ee2c7d66ec80d41191aed269a398d6")
                .unwrap()
                .try_into()
                .unwrap();

        let mut hash_ek = [0u8; 32];
        prf::sha3_256(&pk.key_bytes(), &mut hash_ek); // H(ek)
        let mut m_h_ek: [u8; 64] = [0u8; 64];
        m_h_ek[0..32].copy_from_slice(&m);
        m_h_ek[32..].copy_from_slice(&hash_ek);
        let mut hash = [0u8; 64];

        prf::sha3_512(&m_h_ek, &mut hash); // G(m||H(ek))
        let r: [u8; 32] = hash[32..].try_into().unwrap();

        let ct = pk.encrypt(m.into(), r);
        let exp_ct: [u8; 32usize*(DU as usize * RANK + DV as usize)] = hex::decode("b4d9dfe6717cff99afe645e90f9e9a497833488b2340c1473ceb6c39b944d7cdb748a3e961bdd632d923769aea3b177cf25a36f86f94e80332b720f0f58a134ad8c6f7b31ad0388697864a3d91f43bdc9fa163fe572aecfbaa28d8ceaaa0e92f17eabaebe9d3e117a1bc3c454c3d66e35f7b76baf327d29fbbe8d35142a1e4360a70d0de8d46977a688b6b488720afeb05f846aaafe9fc66aea186961f63264a8a1ae0d721d49385699354b745f46669f89a20b493a836774115736184732b3d0e4374558622ea186d28e822c98dba24f2fa6d233112a89c73994938c362d830aa95113d0989dc4cfdb8d50f0c872d248dcd60212c6c650ddb1679e9419acb2d2ffb8540f578f55a0d03474e3f76fdbbe15af07e3a5251574f6707b2de3a433c0c8a7b04ba67391d27534ac945dc014e9f655068b5c14bea32efec6e6ba1789b1f5c37dca456e52b66ae3a9323671954774caa1697c87dce1d2425326b7185eb986feb59eae87aa2f902e958c6f3c4cc4af8eccb7290ecc824db1a695c3dd643bc0d7c51b416acc184c00c486bb33759be1fe9750cff4282a111723a16e6adae00ea34ecde4b197e8cc1c370635ed2f1e36afa30e76d3c4450ef839c48c016230cb1cdc3b2cd9e64d2e19b50df9633f65db9088177e385502b8a782955cbd6b2e56185e0b3734aa0281734a61c5359d6c4b938424c55a467712ffb555ab782bacc5fd418910a13f28af859ae406bd7fd90490961c12f64927dec576077d4dcdf933c8f6150d8f4f1316c6e28c1f3a0784587621f3d05b6e7ee6877c56cfc97a93c337616c6a940f8d0455fad51fc1233425433ec89055ba451fe31bc51a41f6a4ee8c7aad6f365cce7c373c53bc674111a74fe2c3c187f6615ce07e7b2fd45a148d95f7649ad52ab94bced68b16fa4df9f9906c498be510d7d9d74d33370e893e0bf2f516ea981f06ebf20988ec059bc58835711ad20d8f1f4e47fea65d7f37a5d813dabe1a2c97e1b316d6825bfcd07b592a4834aa204148accda22ce8758335cb3c73db9a51261508eef5b5a2fae5a6a6ec0721313c6ee85d3c29191158d8a3d73d4a475171639a531dd8822682ea4c2375eddbd6df395066e33a16dd5d2cd81f9557268603f2b831fcfe92af431a7780ad0ff9500129ad7959c4975422a1476dfed8a280a24b1158f9fa44dedd77b9a3b883c53cefd56b9ee8bf3a8a3d4d48fda159fa7eb0abc9f69448a8faf53c15ec5f1bd9c6c9eccbf65ede2db9032b22e0a60461a86f3707a3a829968fa59dc21078891c654e8a8fe4d0efa640ee179429e5c0396178c094fdb18b6a4495a518ab6db016629feb51ed10929c4ef3f3710f3170af26a41e197aa709575c0d1a8180f8e81aa6790663a7b2623518734cc9c1d939b2971d011b1de2ad96eb4e87379abcc43334e4b4a4bf8f76cad70ba00465241ee09b6eaf3b93ae18a31fe50f2a05b8b57b76c43e3aec7310e17f385506f771bb7c67cd97f606a2a9db409b3cc3febf2cb0d762490f9aeeb8c9b7b0586").unwrap().try_into().unwrap();
        assert_eq!(ct, exp_ct);

        let ss: [u8; 32] = hash[0..32].try_into().unwrap();
        let exp_ss: [u8; 32] =
            hex::decode("a154db38fa0190042b01911ac8ec66a01f704f397e8e134e70cdf4b773a32484")
                .unwrap()
                .try_into()
                .unwrap();
        assert_eq!(ss, exp_ss);

        let md = dk.decrypt(exp_ct);
        let ct_dash = pk.encrypt(md.into(), r);
        assert_eq!(ct_dash.len(), ct.len());
        assert_eq!(ct_dash, ct);
    }

    #[test]
    fn test_decrypt_01() {
        let d = hex::decode("c1b3cbffad4b306f9af0cdd3028876486dbe858875c9b6497fe20172a986c82b")
            .unwrap();
        let d: [u8; 32] = d.try_into().unwrap();
        let exp_pk: [u8; 1184] = hex::decode("b854a0daebc2831a4f20695579b52d3369af228842776a03c4d3284d763d1f663000930377dc86ab14486673a349d8073ff6ba44496c64467d5f531f5203a074ac7ce9090e59f1c308d2c755910af132ab81b50ad6d6c2c6716190696ae6a51433f61185a43cb1d23708d8286d066b61a6b7f9e13f8248c232d8315f40053fba0d7ffbb4ce60410899200a8a5e51bc1d8392cd56f41fbae85f35b110933a931084444036aab790cc09b84b7a235f34763b9ab5c9b53620f627778c661c4c45b36ebb3a4565795656227fdc280b327ee2f96c16e7bbbde89e9090318787b2abba7727a393cdc04dc38205e3c86ed5d5291a1149ee204b24661ab2ca16c1c0a35d3cca0d7c57f4e01985242c3b43869d9914312678710b039be4c2b775cca014b1d936ca8432a4614c4e67b69620fb49cbc787599c4bffdc3a2c786ba876864e7a5be33ab200bc2d087c3e6cc642f4a96771ba212778046b5823085c4068b209c54a5bd4153e4d986ed3512d09d40c37c1a2e57495e0a594f4430fdb1c88c4fb677b007d8804ca114c0991b90b5140761d59325502a1f0476e961a0c2b2ca78a82c8b5581d98da26de717f84c140fed0a00221ba71c34821374ad7c565ec20cefc949e98d1819702a4d38597c1db9239b9167dfc8651498927bb0e170c151e881577f58963593d3ae00870b8bb9fa3b77c468e8bd365dde088f24c2577c5aae2f24aee1552e4482352674d1d96b90880336ed44f6bf007b5eb67c52a10910a9a3fc82ab8d50aee17b667a27b4d014161f1a60c3084a25524693364ac1876cab0c93c01a153b03486e75c3a01728f625f9a7a6a99e78ea9b77b01490ab49c6dad9ca584229a8a890effe47ce0692aafb17a3db2b855a01666514e8a800a47c0cbfb4872c8c8a4d4bc52c8db43d3f7360d568f4f905ada2565a494901f229ed51bad9106bba6dc4fa7ac59a3a5a64d033be1e47c36c2cc9da10a2bd200b681c2caac5cb1eb03f36455241367d30019aac00afe312c5323cbb4575e271c01f09c6eac03ce1f02bcc4186768493f6cf97671e7a02db6047557306bb8ce086382bbab8312460663dc1bfd01b2411b3c49835690627f133935c27308be6b5d09844f477523521c2b1bb1c92b6b3c46c20cf97217683a3f2e46b0151511c7c9c4bf8620d4706ffaec98e524360986386a7b5c20c312c5b6237bd17271bc6c146124d190205f468dfb00bae08318350c1aa5910a07a67bf13a99a52a39b2b04fa56143c0c1290c5c412ce1647ba8242c851c8bea960c9c4879b83037886ae77b10e8126dd3b633a33a662076cea326765d6262619b8d0c8c3217435450070dbbd67404f5255b6557267178ed99cd4257768e728f3069bc29f8484a127d84098ff4325946371384463c4ff489cd8b6eeed0c5e3e92b1b988c41a31df71047cf78ab1ef9adac2a1ba3121672505ec77b0620617598f84d1fc7b00fdc65e7ab72274c86a424746dc74f53142be6423545d02d581933bb92058563279e522ad8507f4326699bf4831970775640887e875e1cf29a09843210a23976941af397a3c6c5605af133ba94126132311224388f340448a1252c5bc0197b4699aab73a4237d40204a46103bd605bc698111ddc3d6bc04804722c35600b001c554180d16628713bdea10cdf").unwrap().try_into().unwrap();
        let exp_sk: [u8; 2400] = hex::decode("b6f76178bbab01b89443c00292ac914d658044f13fbbd19cd4c0a385141c6a91208665bc45c04ad73185e6e3a0cd102a8cd20547c2335ebb3bd7e9ad50294b07d9a45e617473814ccd41078fb58d2dac1f872c6cb96c73d1aa4356a917c94704a36b9ef791c6c021cf9ed2270685c645a76141f6373b8ab6ab18963b580ae0134d8b175382847811a590080a3dea2b863e06a0990c93839906e2f942b864bee7410bbb17bc1db6373ec99b45754ec78531c205919c27a4f2445b8a777683819709c1c9a3660ccad39941e496aa791ff8d2671b74580df965d0126dc5c034b8b01f31179c1c4746d3820955206b447174eca321a5c22ae852b631e12025b5675385731ba9234ae36cd90c3e16fb5ea2494012b96498f02edc23cd0db74970961fe430129af1b94ad5b1bd95931aecb365fc257c7c1d1668164edc9d2b869a4cc95d54759182c6086785246794a6a0f81431d75fc7189416a9b1efa3832c187fea912474a8a4caa5c9d08b2386240a3d26755111a3a3e830266473b6e02286c10e23ba34ec08c1f643a8f2b74519631706690fbeb5be8bd581175412c1b83da81700ec92bd03b9516a779205c78f726126d67ac2a4c528663acd985296d187c7f6e231a95707d0f9854a4c051a12179678adbf8285b5e58251d08f2da015bcf219edf39f6be56e53b95be3165114616175a5ab44607612fc40ef814c9ba52b6c060c0f11adc8234d865282c3dc5e106753cf221ab2996ab9887ed5334bc7b83d6bb413e1fa9c074903f3c94c685c660ab00a6be85c384478cb42bde6715c9a3bb77b7acab909ce428b955476c85f153263874ca3a7429c6a79a0834c15237dc5fc7a7620897876a3c0970e1b7b789a13482a38c5455a187995960806304ce34b72e676fa589f9823c949981b6eeb887bf7c09ee147645602a640598bd29ac48c94daf0771f46acacaabb4bbb73e841b4be5ccc886987b56cc6e25a7260b3364ec4a897ac22816048756a530ad269759929bcb4ce03435784b25f6f87ca320060d2a1b3b800986cea76229b1d5fba58afa9ac3514289a9b7f63d80f2b48893b376018a0baedec2715b01d61c8cffb63b839c4129c8b97acd904a23a0cc5a38245802ef5eca812870a5717c667ca9bac328f08305621305e5d40980cb7a3f8bb01ec4469b7e17cb4657944a739448a461de11e3bea1d7141a6b7dacf8f41a8f9c6437a9c26ad5b2dffb4974bb7762c76715a9694d5d012e2254ea717369766c22cd9938ec0a4b5a88e7c45b03027926984081414cf7b3a15d46895c362a0a2928c1215601f665d675abfea867957f68178e6621871bd7ac1010abc494517804e68be80151c0aa332102822b0674915208afaa21efb3ba32b0aadc9778869bbab9ad2cf934a690f40917593667cc2ad0cab53c387957ee24960149b07a109465c5de3eb576d99481fec4ca5e8a0de36756f951896322d29c5adfd124c867a5286b59f0c2a0c632c6778a098d39c1e6029285a821c06958671651804e75de2d2414eaa19d0a18003c12f74d50655041aaddc6f5daa6dca8b46367c63bec73ce1e181cc166efe3baa2b986bff325187369982978cdfec651946a4995a20b48b035dbb5eb854a0daebc2831a4f20695579b52d3369af228842776a03c4d3284d763d1f663000930377dc86ab14486673a349d8073ff6ba44496c64467d5f531f5203a074ac7ce9090e59f1c308d2c755910af132ab81b50ad6d6c2c6716190696ae6a51433f61185a43cb1d23708d8286d066b61a6b7f9e13f8248c232d8315f40053fba0d7ffbb4ce60410899200a8a5e51bc1d8392cd56f41fbae85f35b110933a931084444036aab790cc09b84b7a235f34763b9ab5c9b53620f627778c661c4c45b36ebb3a4565795656227fdc280b327ee2f96c16e7bbbde89e9090318787b2abba7727a393cdc04dc38205e3c86ed5d5291a1149ee204b24661ab2ca16c1c0a35d3cca0d7c57f4e01985242c3b43869d9914312678710b039be4c2b775cca014b1d936ca8432a4614c4e67b69620fb49cbc787599c4bffdc3a2c786ba876864e7a5be33ab200bc2d087c3e6cc642f4a96771ba212778046b5823085c4068b209c54a5bd4153e4d986ed3512d09d40c37c1a2e57495e0a594f4430fdb1c88c4fb677b007d8804ca114c0991b90b5140761d59325502a1f0476e961a0c2b2ca78a82c8b5581d98da26de717f84c140fed0a00221ba71c34821374ad7c565ec20cefc949e98d1819702a4d38597c1db9239b9167dfc8651498927bb0e170c151e881577f58963593d3ae00870b8bb9fa3b77c468e8bd365dde088f24c2577c5aae2f24aee1552e4482352674d1d96b90880336ed44f6bf007b5eb67c52a10910a9a3fc82ab8d50aee17b667a27b4d014161f1a60c3084a25524693364ac1876cab0c93c01a153b03486e75c3a01728f625f9a7a6a99e78ea9b77b01490ab49c6dad9ca584229a8a890effe47ce0692aafb17a3db2b855a01666514e8a800a47c0cbfb4872c8c8a4d4bc52c8db43d3f7360d568f4f905ada2565a494901f229ed51bad9106bba6dc4fa7ac59a3a5a64d033be1e47c36c2cc9da10a2bd200b681c2caac5cb1eb03f36455241367d30019aac00afe312c5323cbb4575e271c01f09c6eac03ce1f02bcc4186768493f6cf97671e7a02db6047557306bb8ce086382bbab8312460663dc1bfd01b2411b3c49835690627f133935c27308be6b5d09844f477523521c2b1bb1c92b6b3c46c20cf97217683a3f2e46b0151511c7c9c4bf8620d4706ffaec98e524360986386a7b5c20c312c5b6237bd17271bc6c146124d190205f468dfb00bae08318350c1aa5910a07a67bf13a99a52a39b2b04fa56143c0c1290c5c412ce1647ba8242c851c8bea960c9c4879b83037886ae77b10e8126dd3b633a33a662076cea326765d6262619b8d0c8c3217435450070dbbd67404f5255b6557267178ed99cd4257768e728f3069bc29f8484a127d84098ff4325946371384463c4ff489cd8b6eeed0c5e3e92b1b988c41a31df71047cf78ab1ef9adac2a1ba3121672505ec77b0620617598f84d1fc7b00fdc65e7ab72274c86a424746dc74f53142be6423545d02d581933bb92058563279e522ad8507f4326699bf4831970775640887e875e1cf29a09843210a23976941af397a3c6c5605af133ba94126132311224388f340448a1252c5bc0197b4699aab73a4237d40204a46103bd605bc698111ddc3d6bc04804722c35600b001c554180d16628713bdea10cdf5ca1708c7c6e354b69720b4b4a0c358fe9a6ad3febe78bb2a71691658acae21ab5b9e60227058afd73501b1c4e45adbbd41c7be8d14bcb8e98af77698fdf6b69").unwrap().try_into().unwrap();
        let (pk, dk, _) = pke::key_gen(d);
        assert_eq!(pk.key_bytes(), exp_pk);
        assert_eq!(dk.key_bytes(), &exp_sk[0..384 * RANK]);

        let m: [u8; 32] =
            hex::decode("d70b79de7c2f7cb8d18eaf1ca040f6d8588ba85512ad000b59806ba485538377")
                .unwrap()
                .try_into()
                .unwrap();

        let mut hash_ek = [0u8; 32];
        prf::sha3_256(&pk.key_bytes(), &mut hash_ek); // H(ek)
        let mut m_h_ek: [u8; 64] = [0u8; 64];
        m_h_ek[0..32].copy_from_slice(&m);
        m_h_ek[32..].copy_from_slice(&hash_ek);
        let mut hash = [0u8; 64];

        prf::sha3_512(&m_h_ek, &mut hash); // G(m||H(ek))
        let r: [u8; 32] = hash[32..].try_into().unwrap();

        let ct = pk.encrypt(m.into(), r);
        let exp_ct: [u8; 32usize*(DU as usize * RANK + DV as usize)] = hex::decode("55dbd68fda3206688516d698772a5c8b161cd9005767ce25d7e5330679e87a2798c72cab713db8fa2360c6d3c3e4a34ca20ea29a8ee75f8d7daa3a3331ce40c5f5e6c21b3eb5b34f9bcc6a19421f55c3f8941f33575ca3fb145a6c9f3a47536e1b2e17cf352c4c784c665a156e48e62bd03d62f32b906845620f84c2db619da19dce0a3af9d4169caeca44ff9629dae0a2f4c98611d61c01bd302243c111491bcc9f7e0f3e69d3e1449b1018518617351c3335ec322d2cb971a6633831beb60fcd121747b37becd34ee81e108edb6875ebce0c7ec6d4ac957587f2b57e0c6f693715b7f63301f1edb2298175330e44475f6cac87c64cc1a021f0972fa1512a264f214610eed32035510cfcc3c7555ea0f79047253c665b0bff8611077d0fd845d387468d14b31319c89c9dd64817440c7f4f4f34ec0a34b4ea220ac678c652b6c58d1435de69c309fb9a3a79859e25eddf36743d99c18fd0a1a294770888ae0b65c0dfc9a42cbaee4eb9cc2f74e0971046f8c459c81dbca59097bd247b51640718ddb19ca0075f96c727486880000263a294c9bb561f6eabbbdc80b341e137c986a4fcd7de34fa8a8d33e40a54f0278b81b9e441477f6f47d4ef8b711a7873ed9a419dbd3b90862a82346e5aaf7cfa793387a1419cd488419e59d980ba44a56a5979559773b0698f9107725b0a6970c363650998415edf05f82659526f4183ba93cebda2a058ec3e540913d7ddf60b23448ddaeb7db248e87af5ec701e0ac872e1acfd05570e51318161a1b68dfe176c0992eff1cf834b5a1163104b3e5ef124b591a01d997e0cc20e20879debcd9419c79fb67dca8143534511a002f693f7745e1350e358fd7177cf7810f3004d589ff8cdc2d13b2dd0a74011c2a17bc626d53aba4129921f4876328bb30ce147fb42f0c6b092b4087617d19b0c3d03f98c70c2db5666e0b33d2129b61a47ffb766b0d249e32b3c95e5de203ea1e22287ee5c53e3834552f037fd75a16a8f80ad86230c1600da55abafc4334921f6323a991c1d0d438fc7b991f5093152d244859b7dc1e52653c866e876cd5f1289ebc0bec80363a3a7ce09c7ef7cbfbec389d4721da56a5e39f5cd7c231f0da157c79e2f2cb970fdb273ce2cbe7306e79af4ad182163584df48f2e6c856271177e9cbc47033cc5f5307880a981a928e512d17c59f11382369624ee6773f9dc44f8e0737850d4cc341be9ae4bab7cf7d54ae6e9aef0045e56a34444f0e15b28745a809840f853ae3186e2c84abed57532c6c9b92c5285e333eacb253e7c98570ef0afce1098dc81dac38154c73b9c3a431f152534047406d8cc7f1e58221ddc0750c9f27835b59a63e00097128892b8756a6d52818d3b8f0e3efa3ea99d836a8cbf0144e101340db14977a46c501cb0f0dd3944f38e6c55232fb2b35abe7c5b69f6b68feb675d008da8dd2e9afcd89dcb54c0269596736b62b515fb745471e8b04e2ec4df545bac008eb210f64c4c2ff572e2c5a9657c0ef319ef885e023849320316547e5d").unwrap().try_into().unwrap();
        assert_eq!(ct, exp_ct);

        let ss: [u8; 32] = hash[0..32].try_into().unwrap();
        let exp_ss: [u8; 32] =
            hex::decode("9bd6bcc6cb530617cb4d8107bcedac5524b1a39b5b5ed74c124bcb47a0e115c5")
                .unwrap()
                .try_into()
                .unwrap();
        assert_eq!(ss, exp_ss);

        let md = dk.decrypt(exp_ct);
        let ct_dash = pk.encrypt(md.into(), r);
        assert_eq!(ct_dash.len(), ct.len());
        assert_eq!(ct_dash, ct);
    }
}
